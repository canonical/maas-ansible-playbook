---
# firewall config for maas. First lock down everything except port 22
- name: Allow outgoing connection port 22 (ssh)
  ansible.builtin.iptables:
    chain: OUTPUT
    protocol: tcp
    destination_port: 22
    jump: ACCEPT    

- name: Allow incoming port 22 (ssh)
  ansible.builtin.iptables:
    chain: INPUT
    ctstate: NEW,RELATED,ESTABLISHED
    jump: ACCEPT

- name: Set policy for INPUT chain to drop (otherwise)
  ansible.builtin.iptables:
    chain: INPUT
    policy: DROP

- name: Set policy for FORWARD chain to drop 
  ansible.builtin.iptables:
    chain: FORWARD
    policy: DROP

- name: Allow connections on multiple ports 
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    destination_ports:
      - "{{ maas_port }}"
      - "{{ internal_service_ports }}"
      - "{{ rack_http_port }}"
      - "{{ rpc_ports }}"
    jump: ACCEPT

- name: Allow connections on multiple ports (udp)
  ansible.builtin.iptables:
    chain: INPUT
    protocol: udp
    destination_ports:
      - "{{ maas_port }}"
      - "{{ internal_service_ports }}"
      - "{{ rack_http_port }}"
      - "{{ rpc_ports }}"
    jump: ACCEPT